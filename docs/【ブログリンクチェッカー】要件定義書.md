## ブログ記事リンクチェッカー自動化プロジェクト 要件定義書

### 1. 概要

本プロジェクトは、Googleスプレッドシートで管理されているブログサイトのURLリストに基づき、記事内のハイパーリンクを自動でチェックするツールを開発するものである。Google Apps Script (GAS) がスプレッドシートのデータ準備と結果反映を担当し、AWS Lambdaがコアなリンクチェック処理を実行する。

最新の実行結果は**作業用スプレッドシート**に表示し、過去分を含む全詳細結果は**履歴ログ用の別スプレッドシート**に日付ごとのシートとして保管する。これにより、リンク切れ等の早期発見と履歴管理の両立を目指す。

### 2. システム構成と処理フロー

1.  **【GAS】事前処理 (定時実行)**
    1.  **作業用スプレッドシート**の `実行サマリー` から前回総リンク数を、`実行結果ログ` から前回のエラー詳細リストを読み込む。
    2.  作業用スプレッドシートの `対象リスト` シートの全データをクリアする。
    3.  原本スプレッドシートから、クリアされた `対象リスト` シートへ最新のチェック対象URLリストをコピーする。
    4.  「最新の対象URLリスト」「前回リンク数データ」「前回エラー詳細リスト」を一つのファイルにまとめ、Amazon S3バケットにアップロードする。

2.  **【AWS】メイン処理 (定時実行、GAS処理後に実行)**
    1.  AWS Lambdaが、S3バケットにアップロードされたファイルを読み込む。
    2.  URLリストに基づきリンクチェックを実行し、「今回のエラー詳細リスト」を作成する。
    3.  「今回のエラー詳細リスト」と「前回エラー詳細リスト」を比較し、変更点（新規エラー、修正済みリンク）を検出する。
    4.  チェック結果（実行サマリー、全詳細ログ）と変更点リストをファイルにまとめ、S3バケットにアップロードする。
    5.  実行完了通知をAmazon SNS経由で送信する。通知内容は比較結果に応じて変動させる。

3.  **【GAS】事後処理 (定時実行、AWS処理後に実行)**
    1.  S3バケットにアップロードされた結果ファイルを読み込む。
    2.  **作業用スプレッドシート**の `実行サマリー` と `実行結果ログ` の全データをクリアし、今回の実行結果を書き込む（最新化）。
    3.  **履歴ログ用スプレッドシート**に、実行日の日付（例: `2025-09-03`）で新しいシートを作成する（存在する場合はクリア）。
    4.  新しく作成した日次シートに、今回の**全詳細結果**を書き込む（履歴保管）。

### 3. 機能要件

#### 3.1. Google Apps Script (GAS) の要件
- **データ準備**:
    - `対象リスト` シートのデータをクリアし、原本から最新情報をコピーする機能。
    - `実行サマリー` から前回リンク数を、`実行結果ログ` から前回エラー詳細リストを抽出する機能。
- **データ連携 (AWSへ)**: 抽出した情報を一つのファイルにまとめ、S3へアップロードする機能。
- **結果反映**:
    - S3の結果ファイルを読み込む機能。
    - **作業用スプレッドシート**の各シートをクリアし、最新の結果を書き込む機能。
    - **履歴ログ用スプレッドシート**に日付ベースのシートを生成し、全詳細結果を書き込む機能。

#### 3.2. AWS Lambda (Python) の要件
- **データ入力**: S3から、GASが作成したファイル（対象URL、前回データ）を読み込む機能。
- **リンクチェック処理**: 各ブログの記事内リンクを巡回し、ステータスコードやページ内容に基づき有効性を検証する機能。
- **結果比較と変更検出**: 今回のエラー結果と前回のエラー結果を比較し、「新規エラー」「修正済みリンク」を特定する機能。
- **成果物出力**: 処理結果（サマリー、全詳細ログ、変更点リスト）をファイルとしてS3に出力する機能。
- **完了通知**: 処理完了時に必ず通知を行う。通知内容は以下の通りとする。
    - **前回と結果が全く同じ場合**:
        - 「リンクチェック完了：OK。前回からの変更はありません。」といったシンプルなメッセージを通知する。
    - **前回と結果に違いがある場合**:
        - 「リンクチェック完了：結果に変更がありました。」という件名で、以下の詳細情報を含むメッセージを通知する。
            - **新規エラー**: リンクがあるページのURL、対象のリンクURL、エラー理由
            - **修正済みリンク**: リンクがあるページのURL、対象のリンクURL

### 4. 非機能要件

- **実行環境**: AWS Lambda (Python), Google Apps Script
- **実行スケジュール**: Amazon EventBridge (AWS) と 時間ベースのトリガー (GAS) を利用し、各処理を連携して定時実行する。
- **リトライ処理**: LambdaでのHTTPリクエスト失敗時に、一定回数・間隔でリトライする機構を設けること。
- **ログ管理**: Lambdaの実行ログはAmazon CloudWatch Logsに、GASの実行ログはGoogle Cloudのログに出力する。
- **設定情報の管理**: S3バケット名、エラー判定キーワード、通知先、**作業用スプレッドシートID、履歴ログ用スプレッドシートID**等の設定値は、AWS Systems Manager パラメータストア等で外部管理すること。

### 5. 使用技術・サービス

| 分類 | 技術・サービス名 | 目的 |
| :--- | :--- | :--- |
| **プログラミング言語** | Google Apps Script, Python 3.x | スプレッドシート操作、メイン処理 |
| **実行環境** | Google Apps Script, AWS Lambda | |
| **データ連携** | **Amazon S3** | **GASとLambda間のデータ受け渡し** |
| **トリガー** | GAS 時間ベースのトリガー, Amazon EventBridge | 定期実行スケジューラ |
| **通知** | Amazon SNS | メール、Slack等への通知 |
| **ログ** | Google Cloud Logging, Amazon CloudWatch Logs | 実行ログの保存・監視 |
| **設定管理** | AWS Systems Manager | 設定値の外部管理 |
| **Pythonライブラリ** | `requests`, `BeautifulSoup4`, `boto3` | HTTP通信、HTML解析、AWS連携 |

### 6. 前提・制約条件

- 本ツールは、GASとAWS LambdaがAmazon S3を介して非同期に連携することを前提とする。
- **結果を書き込む作業用スプレッドシートとは別に、全量ログを保管する履歴用のスプレッドシートが別途用意されていることを前提とする。**
- GASからS3へのアクセスには、別途ライブラリの導入や認証情報の設定が必要となる。
- 初期開発時点での対象プラットフォームは、「はてなブログ」および「ライブドアブログ」とする。
- JavaScriptによって動的にレンダリングされるリンクの抽出は、本プロジェクトの範囲外とする。
- 相手サーバーに過度な負荷をかけないよう、リクエスト間隔に適切な待機時間（`sleep`）を設けること。